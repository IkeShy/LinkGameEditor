{"version":3,"sources":["../../../../../assets/commonScript/net/assets/commonScript/net/net_http_core.js"],"names":["tm","NetState","UNKNOWN","NO_NETWORK","WWAN","WIFI","netHttpCore","_netState","netChange","data","get","url","params","cb","target","bLoading","notifierCenter","trigger","Event","EVT_POP_COMMON_SM_HINT","String","NO_NETWORK_HINT","parseGetMsg","xhr","cc","loader","getXMLHttpRequest","timeout","open","setRequestHeader","myAccount","account","token","forEach","eventname","onreadystatechange","httpStatus","status","readyState","response","responseText","LOGD","EVT_POP_COMMON_LOADING_EFFECT","info","JSON","parse","call","httpErrorCode","showHit","NET_ERROR","send","keys","Object","i","length","post","callback","async","nums","arguments","err","sendStr","parsePostMsg","e","APP_CATCH","stringify","init"],"mappings":"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","file":"net_http_core.js","sourceRoot":"../../../../../assets/commonScript/net","sourcesContent":["/**\n *\n * 注意: 标记为Ref的对象为引用对象, 不要在这个类改变属性.\n *\n * 内容: http请求,请求策略: 目前是one by one 可以满足业务需求\n *\n *\n */\n\ntm.NetState = {\n    UNKNOWN : -1,\n    NO_NETWORK : 0,\n    WWAN:1,\n    WIFI:2\n};\n\ntm.netHttpCore =  (function(){\n    var _netState =  -1;\n\n    function netChange (data) {\n        _netState = data['state'];\n    };\n\n    function get(url, params, cb, target, bLoading) {\n\n        bLoading = typeof bLoading == \"undefined\" ? true : bLoading;\n\n        if(_netState == tm.NetState.NO_NETWORK){\n            tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_SM_HINT, tm.String.NO_NETWORK_HINT);\n            return;\n        };\n\n        url = parseGetMsg(url, params);\n\n        let xhr = cc.loader.getXMLHttpRequest();\n        xhr.timeout = 10 * 1000;\n        xhr.open(\"GET\", url, true);\n        xhr.setRequestHeader(\"Content-Type\",\"text/plain;charset=UTF-8\");\n        xhr.setRequestHeader(\"Authorization\", myAccount.account.token); // 添加token认证\n\n        ['abort', 'error', 'timeout'].forEach(function (eventname) {\n            xhr[\"on\" + eventname] = function () {\n                cb(1, eventname);\n            }\n        });\n\n        xhr.onreadystatechange = function () {\n            var httpStatus = xhr.status;\n            if (xhr.readyState == 4 && (httpStatus >= 200 && httpStatus <= 207)) {\n                var response = xhr.responseText;\n                tm.LOGD(\"Http Post\", \"response msg: \", response);\n\n                bLoading && tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_LOADING_EFFECT, false);\n                let info = JSON.parse(response);\n                if(info) {\n                    if(info.status == 0) {\n                        cb && cb.call(target, 0, JSON.parse(response), httpStatus);\n                    } else {\n                        tm.httpErrorCode.showHit(info.status);\n                    }\n                }\n            } else if(xhr.status >= 400){\n\n                bLoading && tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_LOADING_EFFECT, false);\n\n                tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_SM_HINT, tm.String.NET_ERROR);\n                cb && cb.call(target, 1, null, httpStatus);\n            }\n        };\n\n        tm.LOGD(\"Http get send msg: \", url);\n\n        bLoading&&tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_LOADING_EFFECT, true);\n\n        xhr.send();\n    }\n\n    /**\n     * 数据get方法\n     * @param params\n     * @returns {string}\n     */\n    function parseGetMsg(url, params) {\n        if (!params) {\n            return url;\n        }\n\n        let keys = Object.keys(params);\n        for (let i = 0; i < keys.length; i++) {\n            if (i == 0)\n                url += '?'\n            else\n                url += '&';\n            url += (keys[i] + '=' + params[keys[i]]);\n        }\n\n        return url;\n    }\n\n    /**\n     * @param url\n     * @param params\n     * @param callback\n     *\n     * 例子：\n     * let url = mySdk.config.ip + \"/api/bi/getShareList\";\n       let params = {\n            clientId:mySdk.config.clientId\n       };\n\n       tm.netHttpCore.post(url, params, function (error,data) {\n         if(!error){\n            let ret = data['data'];\n\n         }\n       });\n     *\n     */\n    function post(url, params, callback, target, bLoading, async) {\n\n        bLoading = typeof bLoading == \"undefined\" ? true : bLoading;\n\n        if (_netState == tm.NetState.NO_NETWORK) {\n            tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_SM_HINT, tm.String.NO_NETWORK_HINT);\n            return;\n        }\n\n        var nums = arguments.length;\n        if (nums == 2 && typeof  arguments[1] == 'function') {\n            callback = arguments[1];\n            params = \"\";\n        }\n\n        if (typeof async == \"undefined\") {\n            async = true;\n        }\n\n        var xhr = cc.loader.getXMLHttpRequest();\n        xhr.open(\"POST\", url, !!async);\n        xhr.setRequestHeader(\"Content-Type\",\"application/json\");\n        xhr.setRequestHeader(\"Authorization\", myAccount.account.token); // 添加token认证\n        xhr.onreadystatechange = function () {\n            var err = false;\n            if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status <= 207)) {\n                err = false;\n\n                bLoading && tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_LOADING_EFFECT, false);\n\n                let response = xhr.responseText;\n                tm.LOGD(\"Http Post\", \"response msg: \", response);\n\n                if (!response) {\n                    callback && callback.call(target, err, null);\n                } else {\n                    let info = JSON.parse(response);\n                    if(info) {\n                        if(info.status == 0) {\n                            callback && callback.call(target, err, JSON.parse(response));\n                        } else {\n                            tm.httpErrorCode.showHit(info.status);\n                        }\n                    }\n                }\n            } else if(xhr.status >= 400){\n                err = true;\n\n                bLoading&&tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_LOADING_EFFECT, false);\n\n                tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_SM_HINT, tm.String.NET_ERROR);\n\n                tm.LOGD(\"NetHttpCore\", \"xhr readyState: \" + xhr.readyState + \" status: \" + xhr.status);\n            }\n        };\n\n        params = params || {};\n        let sendStr = parsePostMsg(params);\n        tm.LOGD(\"send msg: \", url ,sendStr);\n\n        bLoading&&tm.notifierCenter.trigger(tm.Event.EVT_POP_COMMON_LOADING_EFFECT, true);\n\n        try {\n            xhr.send(sendStr)\n        } catch(e) {\n            tm.notifierCenter.trigger(tm.Event.APP_CATCH, e);\n        }\n    }\n\n    /**\n     * 数据解析方法\n     * @param params\n     * @returns {string}\n     */\n    function parsePostMsg(params) {\n        if (!params) {\n            return \"\";\n        }\n\n        let info = {\n            \"data\": params\n        };\n\n        return JSON.stringify(info);\n    }\n\n    function init(){\n        //TODO:监听网络变化\n    }\n\n    init();\n\n    return {\n        \"get\": get,\n        \"post\": post\n    }\n})();"]}